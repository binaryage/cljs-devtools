# CLJS DevTools FAQ

### What is the `:formatters` feature?

You can log some javascript objects with your own printing routine.
Basically you can register a javascript handler which will be called by
DevTools console to present object in the console. This handler
can output rich formatting / expandable-structure (JsonML).

Read more in [this Google Doc][10].

CLJS DevTools provides a rich set of custom formatters tailored to ClojureScript.

![Custom formatters in action][14]

### What is the `:hints` feature?

Sometimes your DevTools displays cryptic errors like `Cannot read property 'call' of null`.
The problem is in the way how ClojureScript compiler emits function calls.

The `:hints` feature is an attempt to augment uncaught exceptions and error object to include a bit of additional knowledge related to such errors.
It tries to fetch the original source file, extract relevant part to show you more context and mark the javascript error there.
This is expected to work only with `:optimizations none` compiler mode and it is disabled by default because it relies on monkey patching.
But it is worth it:

<img src="https://dl.dropboxusercontent.com/u/559047/cljs-devtools-sanity-hint.png">

Note `<<< ☢ RETURNED NULL ☢ <<< ` part which points to error location. The uncaught error was raised by calling `sanity-test-handler` in the following code:

```clojure
(defn fn-returns-nil [])

(defn sanity-test-handler []
  ((fn-returns-nil) "param"))
```

You can enable the feature in the config:

```clojure
:external-config {
  :devtools/config {
    :features-to-install    [:formatters :hints]
    :fn-symbol              "F"
    :print-config-overrides true}}
```

Or you can enable the feature when calling `install!`:

```clojure
(devtools.core/install! [:formatters :hints])
```

Technical details are described in [the source file][11].

### What is the `:async` feature?

This is an experimental feature.

Chrome DevTools support [async call stacks][1]. It would be great to see full chains of async stack traces for code generated by
 ClojureScript compiler, especially when using [core.async][2] library. To give you concrete picture, we want to see [this][3] instead of [this][4].

There are currently following problems:

1. `core.async` uses `goog.async.nextTick` which is not recognized by Chrome DevTools as async operation participating in async stack traces.
2. Chrome DevTools UI has hard-coded limit for displaying max 4 chained async stack traces which is not enough for common state-machines generated by `core.async` `go` macros.
3. `go-loop` tends to generate state-machines which have very long chains of async stack traces but with repeated patterns for each loop iteration.

CLJS DevTools cannot solve problems `#2` and `#3`, but it can help with `#1` by monkey-patching `goog.async.nextTick`.

The trick is to [replace goog.async.nextTick with a promise-based implementation][5].
ES6 promises participate in Chrome DevTools “async” feature and we can use immediately resolving promises to emulate `nextTick` behaviour.

For problems `#2` and `#3`. I have raised the issue in Chromium issue tracker as [issue #622506][6]. If you want to follow the issue it is also [issue #20][7] in our issue tracker.

Realistically I don't expect Google people to resolve this somehow anytime soon. It is not really that big concern for typical javascript code at the moment.

That is why I'm going to implement experimental support in [Dirac DevTools][8] for this. I have already increased `maxAsyncStackChainDepth`
limit and eventually I will write some code to reduce number of stack traces in `go-loop` chains.

That is why this feature is currently experimental and does not make a lot of sense to enable it without using Dirac DevTools as well.

### Why some custom formatters were not rendered?

First, custom formatters must be enabled in DevTools Settings:

`> DevTools menu > Settings (F1) > Console > Enable custom formatters`

The feature is disabled by default and it is easy to forget to enable it after starting with a new Chrome profile.

Second, please note that custom formatters is a feature of DevTools UI, but console logging is a general feature of Javascript runtime.
When logging happens while DevTools is not attached a different logging system is used for recoding console logs in background.
When DevTools later attaches, existing recorded logs are replayed in the DevTools Console UI. Unfortunately during this replay process
no custom formatters are applied, so you can see only raw logs. There are probably some technical reasons for this behaviour.

To see properly formatted logs you have to refresh your page while DevTools are attached. Any newly printed logs should have
custom formatters applied assuming you have enabled the feature in the DevTools Settings.

This behaviour caused some confusion among users so I implemented a detection and since v0.7 we print a warning
when custom formatters seem not to get rendered.

You can disable this warning by setting this pref prior installation or via [config map][9]:

```clojure
(devtools.core/set-pref! :dont-detect-custom-formatters true)
```

### Why custom formatters do not work for advanced builds?

There is a technical glitch which currently prevents CLJS devtools to work under
:advanced optimizations. Some [ClojureScript type hints are not preserved in advanced builds][12]
and that is why CLJS DevTools cannot recognize objects belonging to CLJS land.

Philosophically you should not include debug/diagnostics code in your production builds anyways.

### How do I elide the library in my :advanced builds?

Please read [installation.md#advanced-builds][13].

### Does this work in other browsers than Chrome?

No, AFAIK.

### What else can I do to improve my ClojureScript development experience?

Check out [Dirac DevTools][8] which is
a custom fork of Chrome DevTools which goes one or two steps further.

[1]: http://www.html5rocks.com/en/tutorials/developertools/async-call-stack
[2]: https://github.com/clojure/core.async
[3]: https://dl.dropboxusercontent.com/u/559047/core-async-long-stack-traces.png
[4]: https://dl.dropboxusercontent.com/u/559047/core-async-normal-traces.png
[5]: https://github.com/binaryage/cljs-devtools/blob/master/src/lib/devtools/async.cljs
[6]: https://bugs.chromium.org/p/chromium/issues/detail?id=622506
[7]: https://github.com/binaryage/cljs-devtools/issues/20
[8]: https://github.com/binaryage/dirac
[9]: https://github.com/binaryage/cljs-devtools/blob/master/docs/configuration.md
[10]: https://docs.google.com/document/d/1FTascZXT9cxfetuPRT2eXPQKXui4nWFivUnS_335T3U
[11]: https://github.com/binaryage/cljs-devtools/blob/master/src/lib/devtools/hints.cljs
[12]: http://dev.clojure.org/jira/browse/CLJS-1249
[13]: installation.md#advanced-builds
[14]: https://dl.dropboxusercontent.com/u/559047/cljs-devtools-sample-full.png
